#!/bin/bash

usage() {
	cat <<EOF

usage: <cfile> <arfcn> <timeslot>

EOF
	exit 1
}

[[ -z $3 ]] && usage

cfile=$1
arfcn=$2
slot=$3

#overrides ok
tcpdump -i lo -w $cfile.${slot}S.pcap &
grgsm_decode -a $arfcn -c $cfile -m SDCCH8 -t $slot
sleep 0.5
pkill tcpdump && echo tcpdump killed ok

echo -n "json for SDCCH/8 timeslot $slot... "
tshark -2 -R '!icmp && gsmtap' -r $cfile.${slot}S.pcap -T text 2>/dev/null | grep Ciphering
tshark -2 -R '!icmp && gsmtap' -r $cfile.${slot}S.pcap -T json > $cfile.${slot}S.json 2>/dev/null \
	&& echo $cfile.${slot}S.json

